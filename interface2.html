<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stacked Bar Chart</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        .bar {
            fill-opacity: 0.6;
        }

        .axis {
            font-size: 14px;
        }

        .legend {
            font-size: 12px;
        }

        #legend-container {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        #sort-form,
        #filter-form {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 8px;
        }

        #filter-form {
            top: 60px;
        }

    </style>
</head>

<body>

    <form id="sort-form">
        Trier par:
        <select id="sortOrder" onchange="updateChart()">
            <option value="alpha">Alphabétique (Z-A)</option>
            <option value="desc">Nombre d'albums décroissant</option>
            <option value="asc">Nombre d'albums croissant</option>
        </select>
    </form>

    <form id="filter-form">
        Afficher :
        <select id="numRows" onchange="updateChart()">
            <option value="5">5 premiers</option>
            <option value="10">10 premiers</option>
            <option value="20">20 premiers</option>
            <option value="all" selected>Tous</option>
        </select>
    </form>

    <div id="legend-container"></div>

    <script>
        const margin = {
            top: 100,
            right: 30,
            bottom: 40,
            left: 200
        },
            width = 1200 - margin.left - margin.right,
            height = 5000 - margin.top - margin.bottom;

        const x = d3.scaleLinear().range([0, width]);
        const y = d3.scaleBand().range([height, 0]).padding(0.1);

        const colors = d3.scaleOrdinal()
            .domain(['<1970', '1970-1980', '1980-1990', '1990-2000', '2000-2010', '2010-2020', '>2020'])
            .range(['rgba(230, 57, 70, 0.8)', 'rgba(244, 162, 97, 0.8)', 'rgba(252, 191, 73, 0.8)', 'rgba(252, 236, 87, 0.8)', 'rgba(153, 217, 140, 0.8)', 'rgba(82, 182, 154, 0.8)', 'rgba(69, 123, 157, 0.8)']);

        const svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        let stackedData = [];

        d3.csv("src/data/quentin_population_album.csv").then(function (data) {
            const dataSum = d3.nest()
                .key(d => d.Genre)
                .key(d => d.année)
                .rollup(v => d3.sum(v, d => d["Nombre d'albums"]))
                .entries(data);

            stackedData = dataSum.map(d => {
                let obj = {
                    Genre: d.key
                };
                d.values.forEach(v => obj[v.key] = v.value);
                return obj;
            });

            drawLegend();
            updateChart();
        });

        function updateChart() {
            svg.selectAll("*").remove();

            let sortOrder = d3.select("#sortOrder").node().value;
            let numRows = d3.select("#numRows").node().value;

            let displayData = stackedData;

            if (numRows !== "all") {
                numRows = parseInt(numRows);
                if (sortOrder === "alpha") {
                    displayData = displayData.slice(0, numRows);
                } else {
                    displayData = displayData.sort((a, b) => d3.sum(colors.domain(), key => (b[key] || 0) - (a[key] || 0))).slice(0, numRows);
                }
            }

            if (sortOrder === "alpha") {
                y.domain(displayData.map(d => d.Genre).sort().reverse());
            } else if (sortOrder === "desc") {
                y.domain(displayData.sort((a, b) => d3.sum(colors.domain(), key => (b[key] || 0) - (a[key] || 0))).map(d => d.Genre));
            } else {
                y.domain(displayData.sort((a, b) => d3.sum(colors.domain(), key => (a[key] || 0) - (b[key] || 0))).map(d => d.Genre));
            }

            x.domain([0, d3.max(displayData, d => d3.sum(colors.domain(), key => d[key] || 0))]);

            colors.domain().forEach((year, i) => {
                svg.selectAll(".bar-" + year.replace(/[><]/g, ""))
                    .data(displayData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar-" + year.replace(/[><]/g, ""))
                    .attr("y", d => y(d.Genre))
                    .attr("x", d => x(d3.sum(colors.domain().slice(0, i), key => d[key] || 0)))
                    .attr("width", d => x(d[year] || 0))
                    .attr("height", y.bandwidth())
                    .attr("fill", colors(year));
            });

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0,0)")
                .call(d3.axisTop(x));

            svg.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(y));
        };

        function drawLegend() {
            const legendRectSize = 15;
            const legendSpacing = 20;
            const legendWidth = 380;
            const legendHeight = 60;

            const legendSvg = d3.select("#legend-container").append("svg")
                .attr("width", legendWidth)
                .attr("height", legendHeight);

            const legendItems = legendSvg.selectAll(".legendItem")
                .data(colors.domain())
                .enter()
                .append("g")
                .attr("class", "legendItem")
                .attr("transform", (d, i) => `translate(${i * (legendWidth / colors.domain().length)}, 0)`);

            legendItems.append("rect")
                .attr("x", 0)
                .attr("y", 20)
                .attr("width", legendWidth / colors.domain().length - 5)
                .attr("height", 15)
                .attr("fill", d => colors(d));

            legendItems.append("text")
                .attr("x", (legendWidth / colors.domain().length) / 2)
                .attr("y", 48)
                .attr("text-anchor", "middle")
                .style("font-size", "0.65em")
                .text(d => d);

            legendSvg.append("text")
                .attr("x", legendWidth / 2)
                .attr("y", 13)
                .attr("text-anchor", "middle")
                .style("font-weight", "bold")
                .style("font-size", "1.25em")
                .style("fill", "black")
                .text("Année de sortie de l'album");
        }

    </script>
</body>

</html>
